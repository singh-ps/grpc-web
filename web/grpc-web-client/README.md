# gRPC-Web Client (Vite + TypeScript)

A minimal browser client demonstrating gRPC‑Web calls with a small UI (Echo and Calculator) built with Vite + TypeScript.

The client talks to a gRPC‑Web endpoint (default http://localhost:10000) and expects protobufs in `../../protos/grpc-web.proto`.

## Features

- Echo: send a message and get it back from the server, with a short history.
- Calculator: pick an `Operation` and two numbers; shows result or an error.
- Typed service client generated from `.proto` files using `protoc` and the `grpc-web` plugin (TypeScript output) plus `google-protobuf` runtime for messages.
- Post‑generation patch adds named exports to the JS generated by `google-protobuf` for smooth ESM interop.

## Project layout

- `index.html` – simple UI for Echo and Calculator
- `src/index.ts` – wires the UI to the client
- `src/grpcWebClient.ts` – lightweight wrapper over the generated service client
- `src/generated/` – generated code (cleared/recreated on regen)
- `proto.sh` – regenerates code from `../../protos/grpc-web.proto`
- `transformGrpcToNamed.js` – patches generated `*_pb.js` files with named exports
- `vite.config.ts`, `tsconfig.json`, `package.json` – build tooling

## Prerequisites

- Node.js 18+ and npm
- `protoc` (Protocol Buffers compiler)
- `protoc-gen-grpc-web` (gRPC‑Web protoc plugin)
  - macOS (Homebrew): `brew install protobuf protoc-gen-grpc-web`
- The `.proto` file at `../../protos/grpc-web.proto` relative to this folder
- A running gRPC‑Web compatible endpoint (or Envoy proxy) reachable at `http://localhost:10000` with CORS enabled for the dev server origin

Notes

- The Vite dev server runs on `http://localhost:8080`. Cross‑origin requests to `:10000` require CORS on the proxy/server.
- If your `google/protobuf/*.proto` include path is custom, `proto.sh` attempts to discover it; adjust if needed.

## Install

```sh
npm install
```

## Generate client code from proto

This cleans `src/generated/` and regenerates the JS (messages) and TS (service client) stubs, then patches named exports for ESM interop.

```sh
npm run proto-regen
```

If you only want to run protoc once without cleaning:

```sh
npm run proto-gen
```

Common errors and fixes

- `protoc not on PATH`: install protobuf compiler (see Prerequisites).
- `protoc-gen-grpc-web: program not found or is not executable`: install `protoc-gen-grpc-web` and ensure it is on PATH.
- `grpc-web.proto: No such file or directory`: verify `PROTO_DIR` in `proto.sh` points to your `.proto` location.

## Run in development

Starts Vite on port 8080 and serves the client.

```sh
npm run dev
```

Open http://localhost:8080 in a browser. Ensure your gRPC‑Web proxy/server is running on http://localhost:10000.

## Build for production

Builds TypeScript and bundles assets to `dist/`. The build also (re)generates protobuf stubs.

```sh
npm run build
```

```sh
npm start
```

## Expected service shape (from usage)

The generated client is `GrpcWebServiceClient` with methods:

- `echo(EchoRequest) -> EchoReply` (client wrapper returns `string`)
- `doMath(MathRequest) -> MathReply` (client wrapper returns `number`)

The `Operation` enum is used to select the calculation in the UI.

Your `grpc-web.proto` should define compatible messages/services. See references in `src/grpcWebClient.ts` and `src/index.ts` for field names used.

## How the generation works

`proto.sh` runs `protoc` with:

- `--js_out=import_style=commonjs,binary` for `google-protobuf` runtime (message classes in JS)
- `--grpc-web_out=import_style=typescript,mode=grpcweb` for the TypeScript service client

Notes

- If you want TypeScript declaration files (`.d.ts`) for message classes, you can optionally enable `ts-protoc-gen` by adding `--ts_out=...` to `proto.sh` (the plugin path is already set via `PROTOC_GEN_TS_PATH`). The repository currently relies on the JS classes from `google-protobuf` and any existing `.d.ts` you've generated previously.

After generation, `transformGrpcToNamed.js` scans `src/generated/**/*_pb.js` and appends named `exports.X = proto.pkg.X` lines based on `goog.exportSymbol` entries. This makes named imports work better under Vite/ESM.

## Troubleshooting

- TypeScript cannot find protobuf types: re‑run `npm run proto-regen` and ensure `src/generated` exists.
- Vite build warnings about CommonJS: `vite-plugin-commonjs` is included to help; ensure `src/generated` files exist before building.

## Scripts

- `npm run dev` – start dev server on `:8080`
- `npm run build` – regenerate protos, type‑check, and build to `dist/`
- `npm start` – build then serve locally (dev server)
- `npm run proto-gen` – run protoc once
- `npm run proto-regen` – clean + protoc
- `npm run clean` – remove `dist/` and `src/generated/`
